<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®å˜æ›´æ£€æµ‹è°ƒè¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>é…ç½®å˜æ›´æ£€æµ‹è°ƒè¯•</h2>
        
        <div id="debugLog" class="alert alert-info">
            <h5>è°ƒè¯•æ—¥å¿—:</h5>
            <div id="logContent"></div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5>æ¨¡æ‹Ÿé…ç½®è¡¨å•</h5>
                <div class="mb-3">
                    <label for="intervalMinutes" class="form-label">æ‰§è¡Œé—´éš” (åˆ†é’Ÿ)</label>
                    <input type="number" class="form-control" id="intervalMinutes" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label for="difyApiKey" class="form-label">Dify API Key</label>
                    <input type="text" class="form-control" id="difyApiKey" value="">
                </div>
                <div class="mb-3">
                    <label for="difyUrl" class="form-label">Dify API URL</label>
                    <input type="url" class="form-control" id="difyUrl" value="">
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-success" id="startTaskBtn">å¯åŠ¨ä»»åŠ¡</button>
                    <button type="button" class="btn btn-warning" id="executeNowBtn">ç«‹å³æ‰§è¡Œ</button>
                    <button type="button" class="btn btn-secondary" id="clearLogBtn">æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message) {
            console.log(message);
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // é…ç½®å˜æ›´æ£€æµ‹å˜é‡
        let originalConfig = null;
        let hasUnsavedChanges = false;
        
        // æ£€æŸ¥é…ç½®æ˜¯å¦æœ‰æœªä¿å­˜çš„å˜æ›´
        function checkConfigChanges() {
            debugLog('ğŸ” å¼€å§‹æ£€æŸ¥é…ç½®å˜æ›´');
            
            if (!originalConfig) {
                debugLog('âŒ originalConfig ä¸ºç©ºï¼Œè¿”å› false');
                return false;
            }
            
            debugLog('âœ… originalConfig å­˜åœ¨: ' + JSON.stringify(originalConfig));
            
            // å®‰å…¨è·å–DOMå…ƒç´ 
            const intervalElement = document.getElementById('intervalMinutes');
            const apiKeyElement = document.getElementById('difyApiKey');
            const urlElement = document.getElementById('difyUrl');
            
            if (!intervalElement || !apiKeyElement || !urlElement) {
                debugLog('âŒ DOMå…ƒç´ è·å–å¤±è´¥');
                return false;
            }
            
            const currentFormData = {
                interval_minutes: parseInt(intervalElement.value) || 0,
                dify_api_key: apiKeyElement.value || '',
                dify_url: urlElement.value || ''
            };
            
            debugLog('ğŸ“‹ å½“å‰è¡¨å•æ•°æ®: ' + JSON.stringify(currentFormData));
            
            hasUnsavedChanges = (
                currentFormData.interval_minutes !== originalConfig.interval_minutes ||
                currentFormData.dify_api_key !== (originalConfig.dify_api_key || '') ||
                currentFormData.dify_url !== (originalConfig.dify_url || '')
            );
            
            debugLog('ğŸ”„ æ˜¯å¦æœ‰å˜æ›´: ' + hasUnsavedChanges);
            
            if (hasUnsavedChanges) {
                debugLog('ğŸ“ å˜æ›´è¯¦æƒ…:');
                if (currentFormData.interval_minutes !== originalConfig.interval_minutes) {
                    debugLog(`  - é—´éš”: ${originalConfig.interval_minutes} â†’ ${currentFormData.interval_minutes}`);
                }
                if (currentFormData.dify_api_key !== (originalConfig.dify_api_key || '')) {
                    debugLog(`  - API Key: "${originalConfig.dify_api_key || ''}" â†’ "${currentFormData.dify_api_key}"`);
                }
                if (currentFormData.dify_url !== (originalConfig.dify_url || '')) {
                    debugLog(`  - URL: "${originalConfig.dify_url || ''}" â†’ "${currentFormData.dify_url}"`);
                }
            }
            
            return hasUnsavedChanges;
        }
        
        // æ˜¾ç¤ºæœªä¿å­˜é…ç½®çš„æç¤º
        function showUnsavedConfigAlert() {
            debugLog('âš ï¸ æ˜¾ç¤ºæœªä¿å­˜é…ç½®æç¤º');
            alert('è¯·å…ˆä¿å­˜é…ç½®åå†æ‰§è¡Œæ­¤æ“ä½œ');
        }
        
        // å¯åŠ¨ä»»åŠ¡æŒ‰é’®äº‹ä»¶
        document.getElementById('startTaskBtn').addEventListener('click', function() {
            debugLog('ğŸš€ å¯åŠ¨ä»»åŠ¡æŒ‰é’®è¢«ç‚¹å‡»');
            
            try {
                if (checkConfigChanges()) {
                    debugLog('ğŸ›‘ æ£€æµ‹åˆ°é…ç½®å˜æ›´ï¼Œæ˜¾ç¤ºæç¤º');
                    showUnsavedConfigAlert();
                    return;
                }
                debugLog('âœ… é…ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¯åŠ¨ä»»åŠ¡');
                alert('é…ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥å¯åŠ¨ä»»åŠ¡ï¼');
            } catch (error) {
                debugLog('âŒ å¼‚å¸¸: ' + error.message);
                console.error('å¯åŠ¨ä»»åŠ¡å¼‚å¸¸:', error);
            }
        });
        
        // ç«‹å³æ‰§è¡ŒæŒ‰é’®äº‹ä»¶
        document.getElementById('executeNowBtn').addEventListener('click', function() {
            debugLog('âš¡ ç«‹å³æ‰§è¡ŒæŒ‰é’®è¢«ç‚¹å‡»');
            
            try {
                if (checkConfigChanges()) {
                    debugLog('ğŸ›‘ æ£€æµ‹åˆ°é…ç½®å˜æ›´ï¼Œæ˜¾ç¤ºæç¤º');
                    showUnsavedConfigAlert();
                    return;
                }
                debugLog('âœ… é…ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œ');
                alert('é…ç½®æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥ç«‹å³æ‰§è¡Œï¼');
            } catch (error) {
                debugLog('âŒ å¼‚å¸¸: ' + error.message);
                console.error('ç«‹å³æ‰§è¡Œå¼‚å¸¸:', error);
            }
        });
        
        // æ¸…ç©ºæ—¥å¿—æŒ‰é’®
        document.getElementById('clearLogBtn').addEventListener('click', function() {
            document.getElementById('logContent').innerHTML = '';
        });
        
        // é¡µé¢åŠ è½½æ—¶è·å–é…ç½®
        window.addEventListener('load', function() {
            debugLog('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è·å–é…ç½®');
            
            axios.get('/api/config')
                .then(function(response) {
                    const config = response.data;
                    debugLog('âœ… æˆåŠŸè·å–é…ç½®: ' + JSON.stringify(config));
                    
                    originalConfig = {
                        interval_minutes: config.interval_minutes,
                        dify_api_key: config.dify_api_key || '',
                        dify_url: config.dify_url || ''
                    };
                    
                    debugLog('ğŸ’¾ åˆå§‹åŒ– originalConfig: ' + JSON.stringify(originalConfig));
                    
                    // æ›´æ–°è¾“å…¥æ¡†
                    document.getElementById('intervalMinutes').value = config.interval_minutes;
                    document.getElementById('difyApiKey').value = config.dify_api_key || '';
                    document.getElementById('difyUrl').value = config.dify_url || '';
                    
                    debugLog('ğŸ”„ è¡¨å•å·²æ›´æ–°ä¸ºå½“å‰é…ç½®');
                })
                .catch(function(error) {
                    debugLog('âŒ è·å–é…ç½®å¤±è´¥: ' + error.message);
                    console.error('è·å–é…ç½®å¤±è´¥:', error);
                });
        });
        
        // ä¸ºè¾“å…¥æ¡†æ·»åŠ å˜æ›´ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ğŸ¯ DOMContentLoaded äº‹ä»¶è§¦å‘');
            
            const configInputs = ['intervalMinutes', 'difyApiKey', 'difyUrl'];
            configInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', function() {
                        debugLog(`ğŸ“ è¾“å…¥æ¡†å˜æ›´: ${inputId} = "${input.value}"`);
                    });
                    input.addEventListener('change', function() {
                        debugLog(`ğŸ”„ è¾“å…¥æ¡†å€¼æ”¹å˜: ${inputId} = "${input.value}"`);
                    });
                }
            });
        });
    </script>
</body>
</html> 