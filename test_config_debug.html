<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置变更检测调试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>配置变更检测调试</h2>
        
        <div id="alertContainer"></div>
        
        <div class="card">
            <div class="card-body">
                <h5>模拟配置表单</h5>
                <div class="mb-3">
                    <label for="intervalMinutes" class="form-label">执行间隔 (分钟)</label>
                    <input type="number" class="form-control" id="intervalMinutes" value="1" min="1">
                </div>
                <div class="mb-3">
                    <label for="difyApiKey" class="form-label">Dify API Key</label>
                    <input type="text" class="form-control" id="difyApiKey" value="app-hSwuMVN43yoNA8MhBhac8sYw">
                </div>
                <div class="mb-3">
                    <label for="difyUrl" class="form-label">Dify API URL</label>
                    <input type="url" class="form-control" id="difyUrl" value="http://192.168.16.105/v1/workflows/run">
                </div>
                
                <hr>
                
                <h5>测试按钮</h5>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-success" id="startTaskBtn">启动任务</button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-warning" id="executeNowBtn">立即执行</button>
                    </div>
                </div>
                
                <hr>
                
                <h5>调试信息</h5>
                <div id="debugInfo" class="alert alert-info">
                    <strong>调试信息将显示在这里</strong>
                </div>
                
                <h5>测试步骤</h5>
                <ol>
                    <li>页面加载后会自动获取原始配置</li>
                    <li>修改任意配置项（比如将间隔时间改为2）</li>
                    <li>点击"启动任务"或"立即执行"按钮</li>
                    <li>观察调试信息和提示</li>
                </ol>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // 全局变量
        let originalConfig = null;
        let hasUnsavedChanges = false;
        
        // 调试日志函数
        function debugLog(message) {
            console.log(message);
            const debugDiv = document.getElementById('debugInfo');
            debugDiv.innerHTML += '<br>' + new Date().toLocaleTimeString() + ': ' + message;
        }
        
        // 显示消息
        function showAlert(message, type = 'info') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
        }
        
        // 检查配置是否有未保存的变更
        function checkConfigChanges() {
            debugLog('checkConfigChanges 被调用');
            
            if (!originalConfig) {
                debugLog('originalConfig 为空，返回 false');
                return false;
            }
            
            debugLog('originalConfig: ' + JSON.stringify(originalConfig));
            
            // 安全获取DOM元素
            const intervalElement = document.getElementById('intervalMinutes');
            const apiKeyElement = document.getElementById('difyApiKey');
            const urlElement = document.getElementById('difyUrl');
            
            if (!intervalElement || !apiKeyElement || !urlElement) {
                debugLog('DOM元素获取失败');
                return false;
            }
            
            const currentFormData = {
                interval_minutes: parseInt(intervalElement.value) || 0,
                dify_api_key: apiKeyElement.value || '',
                dify_url: urlElement.value || ''
            };
            
            debugLog('当前表单数据: ' + JSON.stringify(currentFormData));
            
            hasUnsavedChanges = (
                currentFormData.interval_minutes !== originalConfig.interval_minutes ||
                currentFormData.dify_api_key !== (originalConfig.dify_api_key || '') ||
                currentFormData.dify_url !== (originalConfig.dify_url || '')
            );
            
            debugLog('是否有变更: ' + hasUnsavedChanges);
            return hasUnsavedChanges;
        }
        
        // 显示未保存配置的提示
        function showUnsavedConfigAlert() {
            debugLog('显示未保存配置提示');
            showAlert('请先保存配置后再执行此操作', 'warning');
        }
        
        // 启动任务按钮事件
        document.getElementById('startTaskBtn').addEventListener('click', function() {
            debugLog('启动任务按钮被点击');
            
            try {
                debugLog('开始检查配置变更');
                if (checkConfigChanges()) {
                    debugLog('检测到配置变更，显示提示');
                    showUnsavedConfigAlert();
                    return;
                }
                debugLog('配置检查通过，继续启动任务');
                showAlert('启动任务检查通过！', 'success');
            } catch (error) {
                debugLog('启动任务异常: ' + error.message);
                showAlert('启动任务失败: ' + error.message, 'danger');
            }
        });
        
        // 立即执行按钮事件
        document.getElementById('executeNowBtn').addEventListener('click', function() {
            debugLog('立即执行按钮被点击');
            
            try {
                debugLog('开始检查配置变更');
                if (checkConfigChanges()) {
                    debugLog('检测到配置变更，显示提示');
                    showUnsavedConfigAlert();
                    return;
                }
                debugLog('配置检查通过，继续立即执行');
                showAlert('立即执行检查通过！', 'success');
            } catch (error) {
                debugLog('立即执行异常: ' + error.message);
                showAlert('立即执行失败: ' + error.message, 'danger');
            }
        });
        
        // 页面加载时获取配置
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('页面加载完成，开始获取配置');
            
            try {
                const response = await axios.get('http://localhost:5001/api/config');
                originalConfig = {
                    interval_minutes: response.data.interval_minutes,
                    dify_api_key: response.data.dify_api_key || '',
                    dify_url: response.data.dify_url || ''
                };
                
                debugLog('成功获取原始配置: ' + JSON.stringify(originalConfig));
                
                // 更新表单值
                document.getElementById('intervalMinutes').value = originalConfig.interval_minutes;
                document.getElementById('difyApiKey').value = originalConfig.dify_api_key;
                document.getElementById('difyUrl').value = originalConfig.dify_url;
                
                debugLog('表单值已更新');
                
                // 初始检测
                checkConfigChanges();
                
            } catch (error) {
                debugLog('获取配置失败: ' + error.message);
                showAlert('获取配置失败: ' + error.message, 'danger');
            }
        });
    </script>
</body>
</html> 