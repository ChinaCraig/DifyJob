<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置变更检测测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>配置变更检测测试</h2>
        
        <div id="alertContainer"></div>
        
        <div class="card">
            <div class="card-body">
                <h5>当前配置</h5>
                <div id="currentConfig"></div>
                
                <hr>
                
                <h5>测试步骤</h5>
                <ol>
                    <li>页面加载后会显示当前配置</li>
                    <li>修改任意配置项（不保存）</li>
                    <li>点击"启动任务"或"立即执行"按钮</li>
                    <li>应该看到提示："请先保存配置后再执行此操作"</li>
                    <li>保存配置后，再次点击按钮应该正常执行</li>
                </ol>
                
                <div class="row mt-3">
                    <div class="col-md-6">
                        <button class="btn btn-success" onclick="testStartTask()">测试启动任务</button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-warning" onclick="testExecuteNow()">测试立即执行</button>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>检测结果：</h6>
                    <div id="testResult" class="alert alert-info">等待测试...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let originalConfig = null;
        
        // 显示消息
        function showAlert(message, type = 'info') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById('alertContainer').innerHTML = alertHtml;
        }
        
        // 检查配置是否有未保存的变更
        function checkConfigChanges() {
            if (!originalConfig) return false;
            
            // 模拟从表单获取当前配置（这里用固定值模拟）
            const currentFormData = {
                interval_minutes: 5, // 假设用户修改了间隔时间
                dify_api_key: originalConfig.dify_api_key,
                dify_url: originalConfig.dify_url
            };
            
            const hasChanges = (
                currentFormData.interval_minutes !== originalConfig.interval_minutes ||
                currentFormData.dify_api_key !== originalConfig.dify_api_key ||
                currentFormData.dify_url !== originalConfig.dify_url
            );
            
            document.getElementById('testResult').innerHTML = `
                <strong>配置变更检测结果：</strong><br>
                原始间隔时间: ${originalConfig.interval_minutes} 分钟<br>
                当前间隔时间: ${currentFormData.interval_minutes} 分钟<br>
                是否有变更: ${hasChanges ? '<span class="text-danger">是</span>' : '<span class="text-success">否</span>'}
            `;
            
            return hasChanges;
        }
        
        // 显示未保存配置的提示
        function showUnsavedConfigAlert() {
            showAlert('请先保存配置后再执行此操作', 'warning');
        }
        
        // 测试启动任务
        function testStartTask() {
            if (checkConfigChanges()) {
                showUnsavedConfigAlert();
                return;
            }
            showAlert('启动任务检查通过！', 'success');
        }
        
        // 测试立即执行
        function testExecuteNow() {
            if (checkConfigChanges()) {
                showUnsavedConfigAlert();
                return;
            }
            showAlert('立即执行检查通过！', 'success');
        }
        
        // 页面加载时获取配置
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await axios.get('http://localhost:5001/api/config');
                originalConfig = response.data;
                
                document.getElementById('currentConfig').innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <strong>间隔时间:</strong> ${originalConfig.interval_minutes} 分钟
                        </div>
                        <div class="col-md-4">
                            <strong>API Key:</strong> ${originalConfig.dify_api_key ? originalConfig.dify_api_key.substring(0, 10) + '...' : '未设置'}
                        </div>
                        <div class="col-md-4">
                            <strong>API URL:</strong> ${originalConfig.dify_url || '未设置'}
                        </div>
                    </div>
                `;
                
                // 初始检测
                checkConfigChanges();
                
            } catch (error) {
                showAlert('获取配置失败: ' + error.message, 'danger');
            }
        });
    </script>
</body>
</html> 